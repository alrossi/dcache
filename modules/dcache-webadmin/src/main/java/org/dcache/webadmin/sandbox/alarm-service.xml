<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" 
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
       xmlns:jee="http://www.springframework.org/schema/jee"
       xmlns:context="http://www.springframework.org/schema/context" 
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/jee
                           http://www.springframework.org/schema/jee/spring-jee.xsd
                           http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/context
                           http://www.springframework.org/schema/context/spring-context.xsd 
                           http://www.springframework.org/schema/util 
                           http://www.springframework.org/schema/util/spring-util.xsd">

    <context:property-placeholder/>
    <context:annotation-config/>

    <jee:jndi-lookup id="ServiceCellEndpoint" jndi-name="java:comp/env/serviceCellEndpoint"/>
    
    <bean id="AlarmCellStub" class="org.dcache.cells.CellStub">
        <property name="cellEndpoint" ref="ServiceCellEndpoint"/>
        <property name="destination" value="${httpd.service.alarms}"/>
        <property name="timeout" value="${httpd.service.alarms.timeout}"/>
        <property name="timeoutUnit" value="${httpd.service.alarms.timeout.unit}"/>
    </bean>
    
    <bean id="AlarmService" class="org.dcache.webadmin.sandbox.controller.services.AlarmDataService">
        <property name="accessor" ref="alarmStore"/>
        <property name="alarmService" ref="AlarmCellStub"/>
    </bean>

    <beans profile="alarms-rdbms">
        <!--
            this data source is not wrapped with the AlarmEnabledDataSource
            decorator because we do not want internal errors to become
            alarms
        -->
        <bean id="dataSource" class="com.zaxxer.hikari.HikariDataSource" destroy-method="shutdown">
            <description>Database connection pool</description>
            <constructor-arg>
                <bean class="com.zaxxer.hikari.HikariConfig">
                    <property name="dataSource">
                        <bean class="org.springframework.jdbc.datasource.DriverManagerDataSource">
                            <property name="url" value="${httpd.alarms.db.url}"/>
                            <property name="username" value="${httpd.alarms.db.user}"/>
                            <property name="password" value="${httpd.alarms.db.password}"/>
                        </bean>
                    </property>
                </bean>
            </constructor-arg>
        </bean>

        <bean id="pmf" class="org.datanucleus.api.jdo.JDOPersistenceManagerFactory" destroy-method="close">
            <description>Database persistence manager</description>
            <constructor-arg>
                <util:properties location="file:${httpd.alarms.db.config.path}" local-override="true">
                    <prop key="datanucleus.connectionPoolingType">None</prop>
                </util:properties>
            </constructor-arg>
            <property name="connectionFactory" ref="dataSource"/>
        </bean>

        <bean id="alarmStore" class="org.dcache.webadmin.sandbox.model.accessors.DataNucleusAlarmStore" init-method="initialize"
            destroy-method="shutDown">
            <property name="persistenceManagerFactory" ref="pmf"/>
            <property name="alarmsCleanerEnabled" value="${httpd.enable.alarm-cleaner}"/>
            <property name="alarmsCleanerSleepInterval" value="${httpd.alarm-cleaner.timeout}"/>
            <property name="alarmsCleanerSleepIntervalUnit" value="${httpd.alarm-cleaner.timeout.unit}"/>
            <property name="alarmsCleanerDeleteThreshold" value="${httpd.alarm-cleaner.delete-entries-before}"/>
            <property name="alarmsCleanerDeleteThresholdUnit" value="${httpd.alarm-cleaner.delete-entries-before.unit}"/>
        </bean>
    </beans>

    <beans profile="alarms-xml">
        <bean id="pmf" class="org.datanucleus.api.jdo.JDOPersistenceManagerFactory" destroy-method="close">
            <description>Database persistence manager</description>
            <constructor-arg>
                <util:properties location="file:${httpd.alarms.db.config.path}" local-override="true">
                    <prop key="datanucleus.ConnectionURL">${httpd.alarms.db.url}</prop>
                </util:properties>
            </constructor-arg>
        </bean>

        <bean id="alarmStore" class="org.dcache.webadmin.sandbox.model.accessors.DataNucleusAlarmStore" init-method="initialize"
            destroy-method="shutDown">
            <property name="persistenceManagerFactory" ref="pmf"/>
            <property name="alarmsCleanerEnabled" value="${httpd.enable.alarm-cleaner}"/>
            <property name="alarmsCleanerSleepInterval" value="${httpd.alarm-cleaner.timeout}"/>
            <property name="alarmsCleanerSleepIntervalUnit" value="${httpd.alarm-cleaner.timeout.unit}"/>
            <property name="alarmsCleanerDeleteThreshold" value="${httpd.alarm-cleaner.delete-entries-before}"/>
            <property name="alarmsCleanerDeleteThresholdUnit" value="${httpd.alarm-cleaner.delete-entries-before.unit}"/>
        </bean>
    </beans>

    <beans profile="alarms-off">
        <bean id="alarmStore" class="org.dcache.webadmin.sandbox.model.accessors.NOPAccessor" init-method="initialize"
            destroy-method="shutDown">
        </bean>
    </beans>
</beans>
